# Ollama needs enough RAM for the chat model (e.g. llama3.2:3b ~2.3 GiB).
# On Colima: colima stop && colima start --memory 4
# Low-memory option: set CHAT_OLLAMA_MODEL=tinyllama and OLLAMA_PULL_MODELS=tinyllama mxbai-embed-large
services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        limits:
          memory: 4G
    restart: unless-stopped

  # One-off: pull Ollama models into the ollama service (set OLLAMA_PULL_MODELS in .env to add more)
  ollama-pull:
    image: ollama/ollama:latest
    environment:
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_PULL_MODELS: ${OLLAMA_PULL_MODELS:-llama3.2:3b mxbai-embed-large}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - "sleep 15 && for m in $$OLLAMA_PULL_MODELS; do ollama pull $$m; done"
    depends_on:
      - ollama
    restart: "no"

  postgres:
    image: pgvector/pgvector:pg16
    container_name: rag-postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: agentic_rag
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    restart: unless-stopped

  api:
    build: .
    container_name: rag-api
    ports:
      - "3000:3000"
    environment:
      # App port
      PORT: "3000"

      # DB (override localhost in .env for containers)
      DATABASE_URL: "postgresql://user:password@postgres:5432/agentic_rag?schema=public"

      # Ollama config (override in .env for low-memory: CHAT_OLLAMA_MODEL=tinyllama)
      OLLAMA_BASE_URL: "http://ollama:11434"
      CHAT_OLLAMA_MODEL: "${CHAT_OLLAMA_MODEL:-llama3.2:3b}"
      EMBEDDINGS_OLLAMA_MODEL: "${EMBEDDINGS_OLLAMA_MODEL:-mxbai-embed-large}"
      RAG_RETRIEVAL_K: "8"

      # Optional (only if still used elsewhere)
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY:-}"
      GEMINI_API_KEY: "${GEMINI_API_KEY:-}"

    depends_on:
      - ollama
      - postgres
    restart: unless-stopped

volumes:
  ollama_data:
  pg_data: